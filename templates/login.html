{% extends "base.html" %}
{% block content %}

<h1>Welcome</h1>
<p class="muted">Start typing a username and pick it from the suggestions, then select the matching password and click Login.</p>

<div class="grid">
  <form method="post" action="{{ url_for('main.login') }}" autocomplete="off" spellcheck="false">
    <h2>Sign in</h2>
    {% if error %}<p class="error">{{ error }}</p>{% endif %}

    <!-- USERNAME: typeahead via datalist -->
    <label>Username</label>
    <input
      id="usernameInput"
      name="username"
      list="userOptions"
      placeholder="Start typing… e.g., user3"
      required
      inputmode="text"
      pattern="admin|user[1-9]"
    >
    <datalist id="userOptions">
      <option value="admin"></option>
      {% for i in range(1,10) %}
      <option value="user{{i}}"></option>
      {% endfor %}
    </datalist>

    <!-- PASSWORD: dropdown (enabled only after a valid username is chosen) -->
    <label>Password</label>
    <select id="passwordSelect" name="password" required disabled>
      <option value="" selected disabled>Choose the password…</option>
      <!-- Will be filled by JS with the single matching password -->
    </select>

    <div class="spacer"></div>
    <button type="submit" id="loginBtn">Login</button>

    <noscript>
      <p class="error" style="margin-top:10px">JavaScript is required to select the matching password.</p>
    </noscript>
  </form>

  <!-- Right column left empty (we removed the visible table of test accounts) -->
  <div></div>
</div>

<script>
  // Localhost demo credentials (front-end only for convenience)
  const CREDS = [{ u: 'admin', p: 'admin123' }];
  for (let i = 1; i <= 9; i++) CREDS.push({ u: `user${i}`, p: `pass${i}` });
  const ALLOWED_USERS = new Set(CREDS.map(c => c.u));

  const usernameInput  = document.getElementById('usernameInput');
  const passwordSelect = document.getElementById('passwordSelect');
  const form           = document.querySelector('form');

  function clearPasswordOptions() {
    passwordSelect.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'Choose the password…';
    opt.disabled = true;
    opt.selected = true;
    passwordSelect.appendChild(opt);
  }

  function setPasswordForUser(user) {
    clearPasswordOptions();
    const match = CREDS.find(c => c.u === user);
    if (match) {
      const o = document.createElement('option');
      o.value = match.p;        // will be submitted to server
      o.textContent = match.p;  // shows in dropdown
      passwordSelect.appendChild(o);
      passwordSelect.disabled = false;
      passwordSelect.focus();
    } else {
      passwordSelect.disabled = true;
    }
  }

  function validateAndSet() {
    const user = (usernameInput.value || '').trim();
    if (ALLOWED_USERS.has(user)) {
      setPasswordForUser(user);
    } else {
      clearPasswordOptions();
      passwordSelect.disabled = true;
    }
  }

  // Init
  clearPasswordOptions();
  passwordSelect.disabled = true;

  // When user types or picks a suggestion
  usernameInput.addEventListener('input',  validateAndSet);
  usernameInput.addEventListener('change', validateAndSet);

  // Guard: ensure username is valid before submit
  form.addEventListener('submit', (e) => {
    const user = (usernameInput.value || '').trim();
    if (!ALLOWED_USERS.has(user)) {
      e.preventDefault();
      alert('Please choose a valid username from the suggestions.');
      usernameInput.focus();
    }
  });
</script>

{% endblock %}

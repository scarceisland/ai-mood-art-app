<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - AI Art Mood App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 25px;
            color: #a0a0a0;
            font-size: 14px;
        }

        .error {
            background: #5e2a2a;
            color: #ff8f8f;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #ff5252;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 16px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #6b8cff;
        }

        .spacer {
            height: 20px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: #6b8cff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a7ae0;
        }

        .admin-link {
            text-align: center;
            margin-top: 20px;
        }

        .admin-link a {
            color: #6b8cff;
            text-decoration: none;
        }

        .admin-link a:hover {
            text-decoration: underline;
        }

        .info {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #3d3d3d;
            font-size: 13px;
            color: #888;
        }

        .info p {
            margin-bottom: 8px;
        }

        .username-dropdown {
            position: absolute;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .username-option {
            padding: 10px;
            cursor: pointer;
        }

        .username-option:hover {
            background: #4d4d4d;
        }

        .input-container {
            position: relative;
        }

        .password-display {
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            padding: 12px;
            min-height: 44px;
            font-size: 16px;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>Welcome</h1>
        <p class="subtitle">Select your username to login</p>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="post" action="{{ url_for('main.login') }}">
            <input type="hidden" name="password" id="password_select" value="">

            <div class="form-group">
                <label for="username">Username</label>
                <div class="input-container">
                    <input
                        type="text"
                        id="username"
                        name="username"
                        placeholder="Type or select your username"
                        autocomplete="username"
                        required
                        value="{{ request.form.username if request.form else '' }}"
                    >
                    <div class="username-dropdown" id="usernameDropdown">
                        <div class="username-option" data-username="paul">paul</div>
                        <div class="username-option" data-username="sarah">sarah</div>
                        <div class="username-option" data-username="john">john</div>
                        <div class="username-option" data-username="dana">dana</div>
                        <div class="username-option" data-username="eric">eric</div>
                        <div class="username-option" data-username="fran">fran</div>
                        <div class="username-option" data-username="guest">guest</div>
                        <div class="username-option" data-username="mike">mike</div>
                        <div class="username-option" data-username="lisa">lisa</div>
                        <div class="username-option" data-username="tom">tom</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="password_display">Password</label>
                <div class="password-display" id="password_display">
                    {% if request.form and request.form.password_select %}
                        ••••••••
                    {% else %}
                        Select a username first
                    {% endif %}
                </div>
            </div>

            <div class="spacer"></div>

            <button type="submit">Login</button>
        </form>

        <div class="admin-link">
            <a href="{{ url_for('main.admin_login') }}">Admin Login</a>
        </div>

        <div class="info">
            <p>Images: Pollinations (no key) • Data: PostgreSQL via Supabase • HTMX for no-reload actions</p>
        </div>
    </div>

    <script>
    // SINGLE CLEAN SCRIPT - NO DUPLICATES
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing login page...');

        const usernameInput = document.getElementById('username');
        const passwordSelect = document.getElementById('password_select');
        const passwordDisplay = document.getElementById('password_display');
        const usernameDropdown = document.getElementById('usernameDropdown');
        const usernameOptions = document.querySelectorAll('.username-option');

        // Debug: Check if elements exist
        console.log('Username input:', usernameInput);
        console.log('Password select:', passwordSelect);
        console.log('Password display:', passwordDisplay);
        console.log('Username dropdown:', usernameDropdown);
        console.log('Username options count:', usernameOptions.length);

        // Username to password mapping
        const userPasswords = {
            'paul': 'paul123',
            'sarah': 'sarah123',
            'john': 'john123',
            'dana': 'dana123',
            'eric': 'eric123',
            'fran': 'fran123',
            'guest': 'guest123',
            'mike': 'mike123',
            'lisa': 'lisa123',
            'tom': 'tom123'
        };

        // Show dropdown when username input is focused
        if (usernameInput && usernameDropdown) {
            usernameInput.addEventListener('focus', function() {
                usernameDropdown.style.display = 'block';
                filterDropdown('');
            });
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (usernameInput && usernameDropdown) {
                if (!usernameInput.contains(e.target) && !usernameDropdown.contains(e.target)) {
                    usernameDropdown.style.display = 'none';
                }
            }
        });

        // Filter dropdown options based on input
        if (usernameInput) {
            usernameInput.addEventListener('input', function() {
                filterDropdown(this.value);
                updatePasswordForUsername(this.value);
            });
        }

        // Handle selection from dropdown
        usernameOptions.forEach(option => {
            option.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                if (usernameInput) usernameInput.value = username;
                updatePasswordForUsername(username);
                if (usernameDropdown) usernameDropdown.style.display = 'none';
            });
        });

        // Update password when username changes
        if (usernameInput) {
            usernameInput.addEventListener('change', function() {
                updatePasswordForUsername(this.value);
            });
        }

        // Update password for the given username
        function updatePasswordForUsername(username) {
            const normalizedUsername = username.toLowerCase();
            if (userPasswords[normalizedUsername]) {
                // Set the hidden field (for form submission)
                if (passwordSelect) {
                    passwordSelect.value = userPasswords[normalizedUsername];
                }
                // Set the visible field (for user feedback)
                if (passwordDisplay) {
                    passwordDisplay.textContent = '••••••••';
                }
                console.log("Set password for", username);
            } else {
                if (passwordSelect) {
                    passwordSelect.value = '';
                }
                if (passwordDisplay) {
                    passwordDisplay.textContent = 'Select a username first';
                }
                console.log("No password found for", username);
            }
        }

        // Filter function for dropdown
        function filterDropdown(value) {
            const searchTerm = value.toLowerCase();
            usernameOptions.forEach(option => {
                const username = option.getAttribute('data-username').toLowerCase();
                if (username.includes(searchTerm)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Preserve form values if there was an error
        {% if error and request.form %}
            updatePasswordForUsername('{{ request.form.username }}');
            filterDropdown('{{ request.form.username }}');
        {% endif %}

        // Form submission debug
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log("=== FORM SUBMISSION ===");
                console.log("Username:", document.getElementById('username')?.value);
                console.log("Hidden password:", document.getElementById('password_select')?.value);
            });
        }
    });

    // Safe initialization for window.criterion if it exists
    document.addEventListener('DOMContentLoaded', function() {
        // Check if the criterion library exists before using it
        if (typeof window.criterion !== 'undefined' && typeof window.criterion.initialize === 'function') {
            console.log("Initializing criterion library...");
            try {
                window.wes = window.criterion.initialize();
                console.log("Criterion initialized successfully");
            } catch (e) {
                console.error("Failed to initialize criterion:", e);
            }
        } else {
            console.warn("Criterion library not available - skipping initialization");
        }
    });
    </script>
</body>
</html>